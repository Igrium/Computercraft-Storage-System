-- Code that manages communication between the server and the turtle
os.loadAPI("database")
os.loadAPI("config")
os.loadAPI("navigation")
os.loadAPI("item")

os.loadAPI("network")

-- Navigate and face a direction. Takes a vector and a string
function navigate(destination, direction)
	navigation.navigate(destination.x, destination.y, destination.z)
	navigation.faceDirection(direction)
end

-- Place selected item in given chest, regardless of chest item type
function placeItem(chest, count)
	if navigation.navigate(chest.coordinates.x, chest.coordinates.y, chest.coordinates.z) then
		navigation.faceDirection(chest.direction)
		turtle.drop(count)
	end
end

-- Dumps all items in given chest, regardless of chest item type
function dumpItems(chest)
	if navigation.navigate(chest.coordinates.x, chest.coordinates.y, chest.coordinates.z) then
		navigation.faceDirection(chest.direction)
		item.dump()
	end
end

-- Deposits all of item type into chest, regardless of chest item type
function depositAllOfType(itemInfo, chest)
	if navigation.navigate(chest.coordinates.x, chest.coordinates.y, chest.coordinates.z) then
		navigation.faceDirection(chest.direction)
		item.depositAllOfType(itemInfo)
	end
end

-- Returns how many of an item type it has
function tallyItems(itemInfo)
	local items = 0
	
	for i=1,16,1 do
		if item.equals(turtle.getItemDetail(i), itemInfo) then
			items = items + turtle.getItemCount(i)
		end
	end
	
	return items
end

-- Deposits the item in the selected slot to it's appropriate chest. Boolean [all]: deposit all items of type into chest
function sort(all)
	if turtle.getItemDetail() == nil then
		print("No item in slot "..turtle.getSelectedSlot())
		return false
	end
	
	local itemInfo = turtle.getItemDetail()
	
	-- Deal with scenareo where all is nil
	if all == nil then
		all = false
	end
	
	-- Tally items
	local count = 0
	
	if all then
		count = tallyItems(itemInfo)
	else
		count = turtle.getItemCount()
	end
	
	local chests = database.getAvailableItemLocations(itemInfo, count)
	
	if #chests == 0 or chests == nil then
		--Attempt to sort individually if there's not enough space for all, but if one of them fails, abort
		if all then
			for i=1,16,1 do
				if item.equals(turtle.getItemDetail(i), itemInfo) then
					turtle.select(i)
					if not sort(false) then
						print(itemInfo.name.." is not in the storage system or doesn't have enough space!")
						return false
					end
				end
			end
		end
			
		print(itemInfo.name.." is not in the storage system or doesn't have enough space!")
		return false
	end
	
	local chest = chests[1]
	
	if all then
		depositAllOfType(itemInfo, chest)
	else
		placeItem(chest, turtle.getItemCount())
	end
	
	--Handle situation where not a full stack was dropped
	if all and tallyItems(itemInfo) > 0 then
		item.selectItem(itemInfo)
		return sort(true)
	elseif (not all) and  turtle.getItemCount() > 0 then
		return sort(false)
	end
	
	return true
	
end

-- Sort all of the turtle's items into the storage system. [backupChest]: Chest to deposit unsorted items into
function sortAll(backupChest)
	-- Repeat for each 
	for i=1,16,1 do
		turtle.select(i)
		if turtle.getItemCount() > 0 then
			sort(true)
		end
	end
	-- Put remaining items in backupChest if nessicary
	if (backupChest ~= nil) and item.hasItems() then
		print(backupChest.coordinates)
		dumpItems(backupChest)
	end
	
end

-- Collect a number of items from a chest. Returns: success
function collect(chest, amount, slot)
	-- If there isn't enough space in the slot, divide into multiple slots
	if amount > 64  then
		local success = true
		for i=1,math.floor(amount/64),1 do
			if not collect(chest,64) then
				success = false
			end
		end
		-- Deal with remainder stack
		local remainder = math.fmod(amount, 64)
		
		-- Order of operations means collect isn't run if remainder = 0.
		if remainder > 0 and not collect(chest, remainder) then
			success = false
		end
		return success
	end

	-- Slot default
	if slot == nil then
		slot = item.getLowestOpenSlot()
	end

	if navigation.navigate(chest.coordinates.x,chest.coordinates.y,chest.coordinates.z) then
		navigation.faceDirection(chest.direction)
		turtle.select(slot)
		return turtle.suck(amount)
	else
		return false
	end
end

-- Collect a certian item
function collectItem(itemInfo, amount, slot)
	local chests = database.getFilledItemLocations(itemInfo, amount)
	
	if #chests == 0 or chests == nil then
		print(itemInfo['name'].." is not in the storage system!")
		return false
	end
	
	return collect(chests[1], amount, slot)
end

-- Outputs a pulse of redstone at a given side
function redstoneOutput(side, length)
	redstone.setOutput(side, true)
	os.sleep(length)
	redstone.setOutput(side, false)
end

function main()
	network.setupNetwork()
	navigation.callibrate()
	--sortAll()
	
	sortAll(database.getStorageArrangement()['backupChest'])
end

--main()