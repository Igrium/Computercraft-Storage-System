-- Code that manages communication between the server and the turtle
os.loadAPI("database")
os.loadAPI("config")
os.loadAPI("navigation")
os.loadAPI("item")

-- Place selected item in given chest, regardless of chest item type
function placeItem(slot, chest, count)
	navigation.navigate(chest.coordinates)
	navigation.faceDirection(chest.direction)
	
	turtle.drop(count)
end

-- Dumps all items in given chest, regardless of chest item type
function dumpItems(chest)
	navigation.navigate(chest.coordinates)
	navigation.faceDirection(chest.direction)

	item.dump()
end

-- Deposits all of item type into chest, regardless of chest item type
function depositAllOfType(itemInfo, chest)
	navigation.navigate(chest.coordinates)
	navigation.faceDirection(chest.direction)
	
	item.depositAllOfType(itemInfo)
end

-- Deposits the item in the selected slot to it's appropriate chest. Boolean [all]: deposit all items of type into chest
function sort(all)
	if turtle.getItemDetail() == nil then
		print("No item in slot "..turtle.getSelectedSlot())
		return false
	end
	
	local itemInfo = turtle.getItemDetail()
	local chests = database.getItemLocations(itemInfo)
	
	-- Deal with scenareo where all is nil
	if all == nil then
		all = false
	end
	
	
	if #chests == 0 or chests == nil then
		print(itemInfo.name.." is not in the storage system!")
		return false
	end
	
	local chest = chests[1]
	
	
	if navigation.navigate(chest.coordinates.x, chest.coordinates.y, chest.coordinates.z) then
		navigation.faceDirection(chest.direction)
	
		if all then
			item.depositAllOfType(itemInfo)
		else
			turtle.drop()
		end
		return true
	else
		return false
	end
end

-- Sort all of the turtle's items into the storage system. [backupChest]: Chest to deposit unsorted items into
function sortAll(backupChest)
	-- Repeat for each 
	for i=1,16,1 do
		turtle.select(i)
		if turtle.getItemCount() > 0 then
			sort(true)
		end
	end
	-- Put remaining items in backupChest if nessicary
	if (backupChest ~= nill) and item.hasItems() then
		turtle.dumpItems(backupChest)
	end
	
end

function main()
	navigation.callibrate()
	sortAll()
end

main()